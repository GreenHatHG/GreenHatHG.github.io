<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>CMU213-CSAPP-Virtual-Memory-Concepts | GreenHatHGのBlog</title><meta name="author" content="GreenHatHg"><meta name="copyright" content="GreenHatHg"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="17-Virtual-Memory-ConceptsPhysical and Virtual Addressing Main memory: an array of M contiguous(连续的) byte-size cells(单元). Each byte has a unique..."><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CMU213-CSAPP-Virtual-Memory-Concepts",
  "url": "https://greenhathg.github.io/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/",
  "image": "https://images.unsplash.com/photo-1619075120066-02024cb853bd?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1171&q=80",
  "datePublished": "2022-05-18T14:54:43.000Z",
  "dateModified": "2025-06-15T14:30:38.004Z",
  "author": [
    {
      "@type": "Person",
      "name": "GreenHatHg",
      "url": "https://greenhathg.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="https://avatars0.githubusercontent.com/u/34258355?s=460&u=eb0a1ce09dd045532464cb42f020e8ba1d025b6c&v=4"><link rel="canonical" href="https://greenhathg.github.io/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="&lt;meta name=&quot;google-site-verification&quot; content=&quot;eCt7WHUdmok7J0DG_5L1LtGFqZ_0DeC0ndMY3tBY_rQ&quot; /&gt;"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-116672888-1"></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments)}
gtag('js', new Date())
gtag('config', 'UA-116672888-1')
btf.addGlobalFn('pjaxComplete', () => {
  gtag('config', 'UA-116672888-1', {'page_path': window.location.pathname})
}, 'google_analytics')
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CMU213-CSAPP-Virtual-Memory-Concepts',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://avatars0.githubusercontent.com/u/34258355?s=460&amp;u=eb0a1ce09dd045532464cb42f020e8ba1d025b6c&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">207</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">241</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/mood/"><i class="fa-fw fas fa-glass-cheers"></i><span> 自言自语</span></a></div><div class="menus_item"><a class="site-page" href="/message/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://images.unsplash.com/photo-1619075120066-02024cb853bd?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">GreenHatHGのBlog</span></a><a class="nav-page-title" href="/"><span class="site-name">CMU213-CSAPP-Virtual-Memory-Concepts</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/mood/"><i class="fa-fw fas fa-glass-cheers"></i><span> 自言自语</span></a></div><div class="menus_item"><a class="site-page" href="/message/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">CMU213-CSAPP-Virtual-Memory-Concepts</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-05-18T14:54:43.000Z" title="发表于 2022-05-18 14:54:43">2022-05-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-06-15T14:30:38.004Z" title="更新于 2025-06-15 14:30:38">2025-06-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">2.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>11分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/#post-comment"><span id="twikoo-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:500,&quot;messagePrev&quot;:&quot;已超过&quot;,&quot;messageNext&quot;:&quot;天未更新，某些文章具有时效性，若有错误或已失效，请反馈到greenhat2333@gamil.com&quot;,&quot;postUpdate&quot;:&quot;2025-06-15 14:30:38&quot;}" hidden></div><h1 id="17-Virtual-Memory-Concepts"><a href="#17-Virtual-Memory-Concepts" class="headerlink" title="17-Virtual-Memory-Concepts"></a>17-Virtual-Memory-Concepts</h1><h2 id="Physical-and-Virtual-Addressing"><a href="#Physical-and-Virtual-Addressing" class="headerlink" title="Physical and Virtual Addressing"></a>Physical and Virtual Addressing</h2><ul>
<li><p><strong>Main memory</strong>: an array of M contiguous(<em>连续的</em>) byte-size cells(<em>单元</em>). Each byte has a unique physical address (PA) <code>&#123;0, 1, 2, 3 … &#125;</code></p>
</li>
<li><p>The most natural way for a <strong>CPU to access memory</strong> would be to use physical addresses. We call this approach <strong>physical addressing</strong>.</p>
</li>
<li><p>When the CPU executes the load instruction, it <strong>generates an effective physical address</strong> and <strong>passes it to main memory</strong> over the memory bus. The <strong>main memory fetches the 4-byte word</strong> starting at physical address 4 and <strong>returns it to the CPU</strong>, which <strong>stores it in a register</strong>.<br><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_3.JPG" alt="png"></p>
</li>
<li><p>Modern processors use a form of addressing known as virtual addressing</p>
</li>
<li><p>The CPU accesses main memory by generating a <strong>virtual address</strong> (VA), which is <strong>converted to the appropriate physical address before being sent to main memory</strong>.<br><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_4.JPG" alt="png"></p>
</li>
</ul>
<h2 id="Address-Spaces"><a href="#Address-Spaces" class="headerlink" title="Address Spaces"></a>Address Spaces</h2><ul>
<li>An <strong>address space</strong> is an ordered set of nonnegative integer addresses.(<em>一个非负整数的有序集合</em>)</li>
<li><strong>Linear address space</strong>: Ordered set of contiguous non-negative integer<br>addresses <code>&#123;0, 1, 2, 3 … &#125;</code>。为了简化讨论，后面均采用线性地址空间。</li>
<li><strong>Virtual address space</strong>: Set of N = 2^n virtual addresses <code>&#123;0, 1, 2, 3, …, N-1&#125;</code></li>
<li><strong>Physical address space</strong>: Set of M = 2^m physical addresses <code>&#123;0, 1, 2, 3, …, M-1&#125;</code><br>（N通常大于M）</li>
<li>地址空间明确区分了数据对象data objects (bytes)和它们的attributes (addresses)。</li>
<li>Basic idea of virtual memory: allow <strong>each data object</strong> to have <strong>multiple independent addresses</strong>, each chosen from a <strong>different address space</strong>.</li>
<li>Each byte of main memory has a virtual address chosen from the virtual address space, and a physical address chosen from the physical address space.</li>
</ul>
<h2 id="Why-Virtual-Memory"><a href="#Why-Virtual-Memory" class="headerlink" title="Why Virtual Memory"></a>Why Virtual Memory</h2><ul>
<li>It <strong>uses main memory efficiently</strong> by<ul>
<li>treating it as <strong>a cache</strong> for an address space stored on disk</li>
<li>keeping only the active areas in main memory</li>
<li>transferring data back and forth between disk and memory as needed.</li>
</ul>
</li>
<li>It <strong>simplifies memory management</strong> by providing each process with a uniform address space.</li>
<li>Isolates address spaces<ul>
<li>One process can’t interfere(<em>干涉</em>) with another’s memory</li>
<li>User program cannot access privileged kernel information and code</li>
</ul>
</li>
</ul>
<p>虚拟地址为应用程序提供的功能：</p>
<ul>
<li>create and destroy chunks of memory</li>
<li>map chunks of memory to portions of disk files<ul>
<li>read or modify the contents of a disk file by reading and writing memory locations</li>
<li>load the contents of a file into memory without doing any explicit copying</li>
</ul>
</li>
<li>share memory with other processes</li>
</ul>
<h2 id="VM-as-a-Tool-for-Caching"><a href="#VM-as-a-Tool-for-Caching" class="headerlink" title="VM as a Tool for Caching"></a>VM as a Tool for Caching</h2><ul>
<li><strong>Virtual memory</strong> is an array of N contiguous(<em>连续的</em>) bytes stored on <strong>disk</strong>. Each byte has a unique virtual address that serves as an index into the array. The contents of the array on disk are cached in <strong>physical memory (DRAM cache)</strong></li>
<li>The data on disk is partitioned into <strong>blocks</strong> that serve as the transfer units between the disk and the main memory.</li>
<li>VM systems handle this by partitioning the virtual memory into <strong>fixed-size blocks</strong> called <strong>virtual pages</strong>. Similarly, physical memory is partitioned into <strong>physical pages</strong>.</li>
<li>virtual page有三种<ul>
<li><strong>Unallocated</strong>: have not yet been allocated (or created) by the VM system, do not occupy(<em>占用</em>) any space on disk.</li>
<li><strong>Cached</strong>. Allocated pages that are currently cached in physical memory.</li>
<li><strong>Uncached</strong>. Allocated pages that are not cached in physical memory.</li>
</ul>
</li>
</ul>
<p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_8.JPG" alt="png"></p>
<p>在DRAM的某处缓存了三个virtual page，一些page没有被缓存依旧存储在磁盘上(比如vp2)，有些page甚至没有分配，所以在磁盘上不存在。</p>
<h3 id="DRAM-Cache-Organization"><a href="#DRAM-Cache-Organization" class="headerlink" title="DRAM Cache Organization"></a>DRAM Cache Organization</h3><ul>
<li><p>若未命中DRAM cache，从磁盘中获取数据的代价是非常大的。</p>
<ul>
<li>DRAM is about <strong>10x</strong> slower than SRAM.</li>
<li>Disk is about <strong>10,000x</strong> slower than DRAM.</li>
</ul>
</li>
</ul>
<p>造成的影响：</p>
<ul>
<li>Large page (block) size: typically 4 KB, sometimes 4 MB</li>
<li>Fully associative<ul>
<li>Any VP can be placed in any PP.</li>
<li>Requires a “large” mapping function – different from cache memories.</li>
</ul>
</li>
<li>更复杂的替换算法（替换page），无法在硬件中实现，而替换算法相对简单的cache memory则利用了硬件并行查找。替换失误造成未命中的成本远远大于复杂算法执行的成本。</li>
<li>Write-back rather than write-through</li>
</ul>
<h3 id="Page-table"><a href="#Page-table" class="headerlink" title="Page table"></a>Page table</h3><p>A page table(<em>页表</em>) is an array of page table entries (PTEs) that maps virtual pages to physical pages.</p>
<p>内核会将它作为每一个进程上下文的一部分进行维护，所以每个进程都有自己的页表。</p>
<p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_10.JPG" alt="png"></p>
<p>valid: 1代表当前vp在DRAM中，0且地址不为空代表在磁盘上，0且地址为null代表unallocated page。</p>
<h3 id="Page-hit"><a href="#Page-hit" class="headerlink" title="Page hit"></a>Page hit</h3><p>CPU执行move指令、call指令、ret指令、或者任何类型的控制转移指令，会生成一个虚拟地址。MMU(Memory Management Unit)会在页表中查找。</p>
<p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_11.JPG" alt="png"></p>
<h3 id="Handling-Page-Fault"><a href="#Handling-Page-Fault" class="headerlink" title="Handling Page Fault"></a>Handling Page Fault</h3><ul>
<li><strong>Page fault</strong>: reference to VM word that is not in physical memory (DRAM cache miss)</li>
</ul>
<ol>
<li>Page miss causes page fault (an exception)。硬件触发异常。</li>
<li>导致控制权转移到内核中的page fault handler的代码块</li>
<li>从Physical memory选择出一个page需要被替换，比如pp4。如果vp4被修改过，内核还需要将数据写回到磁盘。</li>
<li>内核从磁盘上获取vp3加载到内存中，并更新Physical memory和页表</li>
<li>当内核中的Page fault handler返回时，它返回到导致错误的指令位置，然后重新执行该指令，page hit。</li>
</ol>
<p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_14.JPG" alt="png"></p>
<p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_16.JPG" alt="png"></p>
<ul>
<li>The activity of transferring a page between disk and memory is- known as <strong>swapping</strong> or <strong>paging</strong>.</li>
<li>All modern systems use <strong>demand paging</strong>.</li>
</ul>
<h3 id="Allocating-Pages"><a href="#Allocating-Pages" class="headerlink" title="Allocating Pages"></a>Allocating Pages</h3><p>page table中的PTE5还没有分配，如果需要分配则要调用malloc函数：先在磁盘上分配这个page(vp5)，PT5指向vp5。并不会一开始就存放在DRMA缓存中，直到被使用到为止。所谓的分配只是修改PTE而已。</p>
<p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_17.JPG" alt="png"></p>
<p>分配新page的时候大多是都会有一个选项，可以分配全为0的page，这样的page不需要存储在磁盘上，它会在内存中，就好像它是在磁盘上创建然后加载到内存中一样，磁盘上不存在这些全为零的pages。page可以映射到文件，code对应的page实际上映射到二进制文件中包含code的部分，当未命中page时候，会将这些code pages加载进来。</p>
<h3 id="Locality-to-the-Rescue-Again"><a href="#Locality-to-the-Rescue-Again" class="headerlink" title="Locality to the Rescue Again"></a>Locality to the Rescue Again</h3><p>虚拟内存因为要复制数据、分配内存、修改页表，甚至可能会出现大量的cache miss而导致swapping，看起来很低效，但是因为局部性原理并不会上面讲的那样低效。</p>
<p>在任何时间点，程序因为局部性倾向于在working set(set of active virtual pages)上工作，具有更好的时间局部性程序的working set会更小。一般来讲，开销比较大的情况只有初始化working set时候将在磁盘的page加载到内存的时候，后续使用working set将会是page hit。</p>
<p>只要程序具有良好的局部性，虚拟内存系统就可以很好地工作，但并不是所有的程序都这样，可能会出现thrashing(<em>抖动</em>)的情况：</p>
<ul>
<li>If (working set size &lt; main memory size): 当前所有的page都在主存</li>
<li>If (SUM(working set sizes) &gt; main memory size)。当所有进程的working set之和大于主存大小，就会导致Thrashing：页面不断的在内存和磁盘之间来回复制。</li>
</ul>
<h2 id="VM-as-a-Tool-for-Memory-Management"><a href="#VM-as-a-Tool-for-Memory-Management" class="headerlink" title="VM as a Tool for Memory Management"></a>VM as a Tool for Memory Management</h2><ul>
<li>Key idea: each process has its own virtual address space。<ul>
<li>It can view memory as a simple linear array.</li>
<li>内核通过为每个进程的上下文中提供属于自己的单独页表来实现。</li>
</ul>
</li>
<li>Simplifying memory allocation<ul>
<li>Each virtual page can be mapped to any physical page</li>
<li>每个进程的页表映射了该进程的虚拟地址空间，虚拟地址空间中的page可以映射到物理地址空间(DRAM)中的任何位置。不同的虚拟页(vp)和不同的进程可以映射到不同的物理页(pp)。</li>
<li>相同的虚拟页也可以在不同的时间存储在不同的物理页中。</li>
<li>每个进程都有一个非常相似的虚拟地址空间，相同大小的地址空间、code和data都从相同的位置开始，但是随后进程使用的page可以分散在内存中，以最有效的方式使用内存。</li>
<li>没有虚拟内存以前，是按物理内存分区的形式为进程分配内存，增加进程及其麻烦，无法知道物理空间位于内存中的哪个地方，需要重新定位等。</li>
</ul>
</li>
<li>Sharing code and data among processes<ul>
<li>Map virtual pages to the same physical page (here: PP 6)</li>
<li>这就是共享库的实现方式，比如共享lib.c，只需要在物理内存中加载一次即可。<br><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_21.JPG" alt="png"></li>
</ul>
</li>
</ul>
<h3 id="Simplifying-Linking-and-Loading"><a href="#Simplifying-Linking-and-Loading" class="headerlink" title="Simplifying Linking and Loading"></a>Simplifying Linking and Loading</h3><p>程序代码和数据一开始没有被加载到内存，只有出现未命中才会进行真正的加载，demand paging。</p>
<p>loading其实是一个非常有效率的机制，可能有一个包含大型数组的程序，但是只访问数组的一部分，延迟加载可以提高性能。</p>
<p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_22.JPG" alt="png"></p>
<h2 id="VM-as-a-Tool-for-Memory-Protection"><a href="#VM-as-a-Tool-for-Memory-Protection" class="headerlink" title="VM as a Tool for Memory Protection"></a>VM as a Tool for Memory Protection</h2><p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_24.JPG" alt="png"></p>
<ul>
<li>sup: supervisor. Processes running in <strong>kernel mode</strong> can access <strong>any page</strong>, but processes running in <strong>user mode</strong> are only allowed to access <strong>pages for which SUP is 0</strong>.</li>
<li>READ and WRITE: control read and write access to the page (i.e., process i is running in user mode: <code>r: vp0/1, rw: vp1, not allowed: vp2</code>)</li>
<li>如果一条指令违背了这些权限，CPU将触发一个exception(通常是segmentation fault)，将控制权转向exception handler，该handler将发送SIGSEGV信号给该进程</li>
</ul>
<p>在x86-64系统上，指针和地址都是64位的，但是虚拟地址空间则是48位的，超过48位的bit要么全是0要么全是1，这是intel制定的规则，高位全为1的地址为内核保留（地址指向内核中的代码或者数据），高位全为0的地址为用户代码保留。</p>
<h2 id="VM-Address-Translation"><a href="#VM-Address-Translation" class="headerlink" title="VM Address Translation"></a>VM Address Translation</h2><h3 id="Address-Translation-With-a-Page-Table"><a href="#Address-Translation-With-a-Page-Table" class="headerlink" title="Address Translation With a Page Table"></a>Address Translation With a Page Table</h3><p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_28.JPG" alt="png"></p>
<p>在intel系统中，页表的起始地址(物理地址)保存在一个特殊的CPU寄存器页表基址寄存器(Page Table Base Register，PTBR)中，它被称为CR3(control register 3：控制寄存器3)</p>
<p>虚拟块中的offset与物理块中的offset相同</p>
<p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_29.JPG" alt="png"></p>
<p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_30.JPG" alt="png"></p>
<h3 id="Speeding-up-Translation-with-a-TLB"><a href="#Speeding-up-Translation-with-a-TLB" class="headerlink" title="Speeding up Translation with a TLB"></a>Speeding up Translation with a TLB</h3><ul>
<li><p>Page table entries (PTEs) are cached in SRAM(L1/L2/L3) like any other memory word</p>
<ul>
<li>PTEs may be evicted(<em>驱逐</em>) by other data references</li>
<li>PTE hit still requires a small L1 delay</li>
</ul>
<p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_31.JPG" alt="png"><br>(In any system that uses both virtual memory and SRAM caches, there is the issue of whether to use virtual or physical addresses to access the SRAM cache. Most systems opt for <strong>physical addressing</strong>.)</p>
</li>
<li><p>Solution: <strong>Translation Lookaside Buffer</strong> (TLB)</p>
<ul>
<li>Small set-associative hardware cache in MMU</li>
<li>Maps virtual page numbers to  physical page numbers</li>
<li>Contains <strong>complete page table entries</strong> for small number of pages</li>
</ul>
</li>
</ul>
<p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_33.JPG" alt="png"></p>
<p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_34.JPG" alt="png"></p>
<p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_35.JPG" alt="png"></p>
<h3 id="Multi-Level-Page-Tables"><a href="#Multi-Level-Page-Tables" class="headerlink" title="Multi-Level Page Tables"></a>Multi-Level Page Tables</h3><p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_36.JPG" alt="png"></p>
<p>一个页表需要的空间很大，见图，需要512GB，因为如果想用一个页表映射虚拟地址空间，需要为每个page的地址提供一个PTE，不管page有没有被使用过，因为不确定这些地址空间哪些需要被覆盖，比如48位地址空间，则需要512GB，但是很多都没有使用到，为此使用多级页表可以避免创建不必要的页表。</p>
<p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_37.JPG" alt="png"></p>
<p>上图已经为这个程序的代码和数据分配了2k个page，还有6个没有分配的page，底下有一个为栈分配的1024个page，但是大部分没有使用，只为栈顶分配了一个page。</p>
<p>2个level 2的页表覆盖了这分配的2k个page，1个level 2页表覆盖栈page(1023个null PTEs，因为大部分没有使用到)，1个level 1页表，共需要4个页表。</p>
<p>足够的level 2的页表就能覆盖实际使用的虚拟地址空间部分。没有用到的page就放到Gap区域，无需为它搞一个页表。</p>
<p>reduces memory requirements in two ways</p>
<ol>
<li>if a PTE in the level 1 table is null, then the corresponding level 2 page table does not even have to exist.</li>
<li>The level 2 page tables can be <strong>created and paged in and out</strong> by the VM system as they are needed, which reduces pressure on main memory. <strong>Only the most heavily used level 2 page tables need to be cached in main memory.</strong></li>
</ol>
<h3 id="Translating-with-a-k-level-Page-Table"><a href="#Translating-with-a-k-level-Page-Table" class="headerlink" title="Translating with a k-level Page Table"></a>Translating with a k-level Page Table</h3><p><img src="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/17-vm-concepts_38.JPG" alt="png"></p>
<p>MMU做的这些都是硬件逻辑，包括有多少级页表，由硬件架构定义。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://greenhathg.github.io">GreenHatHg</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://greenhathg.github.io/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/">https://greenhathg.github.io/2022/05/18/CMU213-CSAPP-Virtual-Memory-Concepts/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://greenhathg.github.io" target="_blank">GreenHatHGのBlog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CMU213/">CMU213</a><a class="post-meta__tags" href="/tags/CSAPP/">CSAPP</a><a class="post-meta__tags" href="/tags/virtual-memory/">virtual-memory</a><a class="post-meta__tags" href="/tags/OS/">OS</a></div><div class="post-share"><div class="social-share" data-image="https://images.unsplash.com/photo-1619075120066-02024cb853bd?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Systems/" title="CMU213-CSAPP-Virtual-Memory-Systems"><img class="cover" src="https://images.unsplash.com/photo-1620880762272-c2bf6b4f1ce2?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">CMU213-CSAPP-Virtual-Memory-Systems</div></div><div class="info-2"><div class="info-item-1">18-Virtual-Memory-SystemsSimple memory system exampleAddress Translation Example #1 PPN实际不存在页表中  MMU做的第一件事是检查TLB，将VA中的VPN的TLBI(0x3)和TLBT(0x03)提取出来。所以会去查set3找到tag为3的line，找到对应的line并且valid为1，TLB将PPN(0D)返回给MMU MMU使用0D构建物理地址。将VA的VPO复制到PA的PPO，0D作为PA的PPN，由此构成了一个物理地址 将地址发送给cache，提取出CI(0x5)、CT(0x0D)，所以会去查set5找到tag为0xD的line，找到并且valid为1，因为CO为0，所以找到B0(36) cache将该字节通过MMU返回给CPU，并将其存到一个寄存器中。  Address Translation Example #2  VA中的VPN的TLBI=TLBT=0，TLB的set=0&amp;tag=0的line的valid=0，TLB...</div></div></div></a><a class="pagination-related" href="/2022/05/07/%E7%8E%A9%E5%AE%A2%E4%BA%91%E9%83%A8%E7%BD%B2beancount-telegram-bot/" title="玩客云部署beancount-telegram-bot"><img class="cover" src="https://images.unsplash.com/photo-1620880762296-f9787c134352?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;ixlib=rb-1.2.1&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">玩客云部署beancount-telegram-bot</div></div><div class="info-2"><div class="info-item-1">玩客云捡垃圾，40块钱还行，民间大佬弄出了刷Linux的方法，可惜是32位，不过也凑合用，比斐讯N1折腾了那么一点。  beancountbeancount介绍可以看下面几个文章，整挺好。之前是用ios端的Moze3，感觉还是差了点意思。 Beancount复式记账（一）：为什么 复式记账指北（三）：如何打造不半途而废的记账方案 使用 Beancount 管理家庭财务 · 构建我的被动收入 使用 Costflow 提高 Beancount 记账效率 bot-docker这里推荐使用kaaass/beancount_bot_costflow_docker，参考上面第二篇文章，里面有详细说明。不过上面的镜像只支持64位，只能自己弄32位的docker镜像。 Dockerfile从beancount_bot_costflow_docker的Dockerfile修改而来 12345678910111213141516171819202122232425262728FROM alpine:3.6WORKDIR /appADD requirements.txt /appENV...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2022/05/18/CMU213-CSAPP-Virtual-Memory-Systems/" title="CMU213-CSAPP-Virtual-Memory-Systems"><img class="cover" src="https://images.unsplash.com/photo-1620880762272-c2bf6b4f1ce2?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1171&q=80" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2025-06-15</div><div class="info-item-2">CMU213-CSAPP-Virtual-Memory-Systems</div></div><div class="info-2"><div class="info-item-1">18-Virtual-Memory-SystemsSimple memory system exampleAddress Translation Example #1 PPN实际不存在页表中  MMU做的第一件事是检查TLB，将VA中的VPN的TLBI(0x3)和TLBT(0x03)提取出来。所以会去查set3找到tag为3的line，找到对应的line并且valid为1，TLB将PPN(0D)返回给MMU MMU使用0D构建物理地址。将VA的VPO复制到PA的PPO，0D作为PA的PPN，由此构成了一个物理地址 将地址发送给cache，提取出CI(0x5)、CT(0x0D)，所以会去查set5找到tag为0xD的line，找到并且valid为1，因为CO为0，所以找到B0(36) cache将该字节通过MMU返回给CPU，并将其存到一个寄存器中。  Address Translation Example #2  VA中的VPN的TLBI=TLBT=0，TLB的set=0&amp;tag=0的line的valid=0，TLB...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://avatars0.githubusercontent.com/u/34258355?s=460&amp;u=eb0a1ce09dd045532464cb42f020e8ba1d025b6c&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">GreenHatHg</div><div class="author-info-description">巴拉巴拉能量! rm -rf / --no-preserve-root</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">207</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">241</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/GreenHatHG"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/GreenHatHG" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:greenhat2333@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#17-Virtual-Memory-Concepts"><span class="toc-number">1.</span> <span class="toc-text">17-Virtual-Memory-Concepts</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Physical-and-Virtual-Addressing"><span class="toc-number">1.1.</span> <span class="toc-text">Physical and Virtual Addressing</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Address-Spaces"><span class="toc-number">1.2.</span> <span class="toc-text">Address Spaces</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why-Virtual-Memory"><span class="toc-number">1.3.</span> <span class="toc-text">Why Virtual Memory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VM-as-a-Tool-for-Caching"><span class="toc-number">1.4.</span> <span class="toc-text">VM as a Tool for Caching</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DRAM-Cache-Organization"><span class="toc-number">1.4.1.</span> <span class="toc-text">DRAM Cache Organization</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Page-table"><span class="toc-number">1.4.2.</span> <span class="toc-text">Page table</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Page-hit"><span class="toc-number">1.4.3.</span> <span class="toc-text">Page hit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Handling-Page-Fault"><span class="toc-number">1.4.4.</span> <span class="toc-text">Handling Page Fault</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Allocating-Pages"><span class="toc-number">1.4.5.</span> <span class="toc-text">Allocating Pages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Locality-to-the-Rescue-Again"><span class="toc-number">1.4.6.</span> <span class="toc-text">Locality to the Rescue Again</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VM-as-a-Tool-for-Memory-Management"><span class="toc-number">1.5.</span> <span class="toc-text">VM as a Tool for Memory Management</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Simplifying-Linking-and-Loading"><span class="toc-number">1.5.1.</span> <span class="toc-text">Simplifying Linking and Loading</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VM-as-a-Tool-for-Memory-Protection"><span class="toc-number">1.6.</span> <span class="toc-text">VM as a Tool for Memory Protection</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VM-Address-Translation"><span class="toc-number">1.7.</span> <span class="toc-text">VM Address Translation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Address-Translation-With-a-Page-Table"><span class="toc-number">1.7.1.</span> <span class="toc-text">Address Translation With a Page Table</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Speeding-up-Translation-with-a-TLB"><span class="toc-number">1.7.2.</span> <span class="toc-text">Speeding up Translation with a TLB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Multi-Level-Page-Tables"><span class="toc-number">1.7.3.</span> <span class="toc-text">Multi-Level Page Tables</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Translating-with-a-k-level-Page-Table"><span class="toc-number">1.7.4.</span> <span class="toc-text">Translating with a k-level Page Table</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/06/15/Xueqiu_ShanXing-summary-2025-06-15-14-30-27/" title="[Xueqiu_ShanXing] 发言时段总结 - 2025-06-15 14:30"><img src="https://images.unsplash.com/photo-1619075120066-02024cb853bd?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="[Xueqiu_ShanXing] 发言时段总结 - 2025-06-15 14:30"/></a><div class="content"><a class="title" href="/2025/06/15/Xueqiu_ShanXing-summary-2025-06-15-14-30-27/" title="[Xueqiu_ShanXing] 发言时段总结 - 2025-06-15 14:30">[Xueqiu_ShanXing] 发言时段总结 - 2025-06-15 14:30</a><time datetime="2025-06-15T14:30:27.000Z" title="发表于 2025-06-15 14:30:27">2025-06-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/15/Xueqiu_Forever-summary-2025-06-15-14-30-24/" title="[Xueqiu_Forever] 发言时段总结 - 2025-06-15 14:30"><img src="https://images.unsplash.com/photo-1620880762258-273a49958090?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="[Xueqiu_Forever] 发言时段总结 - 2025-06-15 14:30"/></a><div class="content"><a class="title" href="/2025/06/15/Xueqiu_Forever-summary-2025-06-15-14-30-24/" title="[Xueqiu_Forever] 发言时段总结 - 2025-06-15 14:30">[Xueqiu_Forever] 发言时段总结 - 2025-06-15 14:30</a><time datetime="2025-06-15T14:30:24.000Z" title="发表于 2025-06-15 14:30:24">2025-06-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/15/Xueqiu_OKaSiJiZhangShiFu-summary-2025-06-15-14-30-24/" title="[Xueqiu_OKaSiJiZhangShiFu] 发言时段总结 - 2025-06-15 14:30"><img src="https://images.unsplash.com/photo-1620880762296-f9787c134352?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;ixlib=rb-1.2.1&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="[Xueqiu_OKaSiJiZhangShiFu] 发言时段总结 - 2025-06-15 14:30"/></a><div class="content"><a class="title" href="/2025/06/15/Xueqiu_OKaSiJiZhangShiFu-summary-2025-06-15-14-30-24/" title="[Xueqiu_OKaSiJiZhangShiFu] 发言时段总结 - 2025-06-15 14:30">[Xueqiu_OKaSiJiZhangShiFu] 发言时段总结 - 2025-06-15 14:30</a><time datetime="2025-06-15T14:30:24.000Z" title="发表于 2025-06-15 14:30:24">2025-06-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/15/Xueqiu_ManBuJiaZhiXian-summary-2025-06-15-04-30-29/" title="[Xueqiu_ManBuJiaZhiXian] 发言时段总结 - 2025-06-15 04:30"><img src="https://images.unsplash.com/photo-1618170673668-0eea9c66d40c?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="[Xueqiu_ManBuJiaZhiXian] 发言时段总结 - 2025-06-15 04:30"/></a><div class="content"><a class="title" href="/2025/06/15/Xueqiu_ManBuJiaZhiXian-summary-2025-06-15-04-30-29/" title="[Xueqiu_ManBuJiaZhiXian] 发言时段总结 - 2025-06-15 04:30">[Xueqiu_ManBuJiaZhiXian] 发言时段总结 - 2025-06-15 04:30</a><time datetime="2025-06-15T04:30:29.000Z" title="发表于 2025-06-15 04:30:29">2025-06-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/15/Xueqiu_GuanWoCai-summary-2025-06-15-04-30-27/" title="[Xueqiu_GuanWoCai] 发言时段总结 - 2025-06-15 04:30"><img src="https://images.unsplash.com/photo-1619342802099-027bc73e30eb?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="[Xueqiu_GuanWoCai] 发言时段总结 - 2025-06-15 04:30"/></a><div class="content"><a class="title" href="/2025/06/15/Xueqiu_GuanWoCai-summary-2025-06-15-04-30-27/" title="[Xueqiu_GuanWoCai] 发言时段总结 - 2025-06-15 04:30">[Xueqiu_GuanWoCai] 发言时段总结 - 2025-06-15 04:30</a><time datetime="2025-06-15T04:30:27.000Z" title="发表于 2025-06-15 04:30:27">2025-06-15</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2025 By GreenHatHg</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://blog-twikoo-khaki.vercel.app',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://blog-twikoo-khaki.vercel.app',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    GLOBAL_CONFIG_SITE.pageType === 'post' && getCount()

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>