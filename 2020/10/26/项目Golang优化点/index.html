<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>项目Golang优化点 | GreenHatHGのBlog</title><meta name="author" content="GreenHatHg"><meta name="copyright" content="GreenHatHg"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、前言最近接手的一个项目需要预先生成大量缓存（并不是一个好方案，最终ban掉了），在生成缓存处理数据中发现了一些优化点，可以提高速度，在此记录一下，首先可以了解一下如何利用工具找出代码中一些代码块的执行速度。 二、pprof2.1 简介google/pprof pprof..."><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "项目Golang优化点",
  "url": "https://greenhathg.github.io/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/",
  "image": "https://images.unsplash.com/photo-1620880762258-273a49958090?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1171&q=80",
  "datePublished": "2020-10-26T17:16:46.000Z",
  "dateModified": "2025-06-14T09:17:00.390Z",
  "author": [
    {
      "@type": "Person",
      "name": "GreenHatHg",
      "url": "https://greenhathg.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="https://avatars0.githubusercontent.com/u/34258355?s=460&u=eb0a1ce09dd045532464cb42f020e8ba1d025b6c&v=4"><link rel="canonical" href="https://greenhathg.github.io/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="&lt;meta name=&quot;google-site-verification&quot; content=&quot;eCt7WHUdmok7J0DG_5L1LtGFqZ_0DeC0ndMY3tBY_rQ&quot; /&gt;"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-116672888-1"></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments)}
gtag('js', new Date())
gtag('config', 'UA-116672888-1')
btf.addGlobalFn('pjaxComplete', () => {
  gtag('config', 'UA-116672888-1', {'page_path': window.location.pathname})
}, 'google_analytics')
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '项目Golang优化点',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://avatars0.githubusercontent.com/u/34258355?s=460&amp;u=eb0a1ce09dd045532464cb42f020e8ba1d025b6c&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">197</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">237</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/mood/"><i class="fa-fw fas fa-glass-cheers"></i><span> 自言自语</span></a></div><div class="menus_item"><a class="site-page" href="/message/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://images.unsplash.com/photo-1620880762258-273a49958090?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">GreenHatHGのBlog</span></a><a class="nav-page-title" href="/"><span class="site-name">项目Golang优化点</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/mood/"><i class="fa-fw fas fa-glass-cheers"></i><span> 自言自语</span></a></div><div class="menus_item"><a class="site-page" href="/message/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">项目Golang优化点</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-10-26T17:16:46.000Z" title="发表于 2020-10-26 17:16:46">2020-10-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-06-14T09:17:00.390Z" title="更新于 2025-06-14 09:17:00">2025-06-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">2.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>9分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/#post-comment"><span id="twikoo-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:500,&quot;messagePrev&quot;:&quot;已超过&quot;,&quot;messageNext&quot;:&quot;天未更新，某些文章具有时效性，若有错误或已失效，请反馈到greenhat2333@gamil.com&quot;,&quot;postUpdate&quot;:&quot;2025-06-14 09:17:00&quot;}" hidden></div><h1 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h1><p>最近接手的一个项目需要<del>预先生成大量缓存（并不是一个好方案，最终ban掉了）</del>，在生成缓存处理数据中发现了一些优化点，可以提高速度，在此记录一下，首先可以了解一下如何利用工具找出代码中一些代码块的执行速度。</p>
<h1 id="二、pprof"><a href="#二、pprof" class="headerlink" title="二、pprof"></a>二、pprof</h1><h2 id="2-1-简介"><a href="#2-1-简介" class="headerlink" title="2.1 简介"></a>2.1 简介</h2><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/google/pprof">google/pprof</a></p>
<p>pprof 是用于可视化和分析性能分析数据的工具，这里主要用来定位性能问题</p>
<p>主要有以下数据：</p>
<ul>
<li><code>CPU Profiling</code>：CPU 分析，按照一定的频率采集所监听的应用程序 CPU（含寄存器）的使用情况，可确定应用程序在主动消耗 CPU 周期时花费时间的位置</li>
<li><code>Memory Profiling</code>：内存分析，在应用程序进行堆分配时记录堆栈跟踪，用于监视当前和历史内存使用情况，以及检查内存泄漏</li>
<li><code>Block Profiling</code>：阻塞分析，记录 goroutine 阻塞等待同步（包括定时器通道）的位置</li>
<li><code>Mutex Profiling</code>：互斥锁分析，报告互斥锁的竞争情况</li>
</ul>
<p>这里我们主要用到第一点</p>
<h2 id="2-2-结果分析"><a href="#2-2-结果分析" class="headerlink" title="2.2 结果分析"></a>2.2 结果分析</h2><p>这里使用的是web应用，可以使用 <code>net/http/pprof</code>库，它能够在提供 HTTP 服务进行分析</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> tool pprof <span class="string">&quot;http://127.0.0.1:8090/debug/pprof/profile&quot;</span></span><br></pre></td></tr></table></figure>
<p>输入命令后并调用接口，30s后会暂停，然后输入<code>web</code>命令出现下面的页面</p>
<p>这个是pprof的<code>Graph</code>视图，记录了调用方法所花的时间和调用链，<strong>我们一般会关注红色颜色比较深的那一块，然后找到自己写的方法</strong></p>
<p><img src="/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/Untitled.png" alt></p>
<p><img src="/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/pprof-graph_(1" alt>.png)</p>
<h2 id="2-3-找到关键部分"><a href="#2-3-找到关键部分" class="headerlink" title="2.3 找到关键部分"></a>2.3 找到关键部分</h2><p><img src="/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/Untitled%201.png" alt></p>
<p>从顶端开始找到第一个自己的业务方法，这里为<code>GetDetailsInfo</code> </p>
<p>然后我们可以输入命令<code>list GetDetailsInfo</code> 获得详细信息</p>
<p><img src="/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/Untitled%202.png" alt></p>
<p>这里定位到60行花销的时间最多，但是这个还是个方法，我们可以回到终端输入<code>web GetDetailsInfo</code>  命令显示详细一点信息。</p>
<p>![]项目Golang优化点/Untitled%203.png)</p>
<p>定位128行，这里是使用的<code>GoFrame</code>框架带的orm查询语句，再往下的代码则是框架的源码，至此，利用pprof找问题可以告一段落</p>
<h1 id="三、优化点"><a href="#三、优化点" class="headerlink" title="三、优化点"></a>三、优化点</h1><h2 id="3-1-反序列化"><a href="#3-1-反序列化" class="headerlink" title="3.1 反序列化"></a>3.1 反序列化</h2><h3 id="3-1-1-找出关键点"><a href="#3-1-1-找出关键点" class="headerlink" title="3.1.1 找出关键点"></a>3.1.1 找出关键点</h3><p>对同一接口调用三次，然后利用pprof找出缺陷点</p>
<p><img src="/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/Untitled%204.png" alt></p>
<p>这里面可以看到，绝大部分时间都花在了<code>FindAll</code> 方法上面了，查看这一部分源码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tapd_bugs.FindAll(tapd_bugs.Columns.WorkspaceName, workspaceName)</span><br></pre></td></tr></table></figure>
<p>这一部分代码的作用是从数据库拿出数据并反序列化到结构体上面，SQL查询语句相当于</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM tapd_bugs</span><br><span class="line">WHERE workspace_name = <span class="string">&quot;xxx&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>首先我们得查看从数据库拿出数据大概需要多久</p>
<p>从程序打印出来的log日志中看到，从数据库拿数据花费的时间不到10ms（大概8w数据）</p>
<p>![]项目Golang优化点/Untitled%205.png)</p>
<p>那么问题可能出在了反序列化上面了，这里的反序列化意思大概是</p>
<p>拿到的数据格式大概是这样，是一个json数组（这里实际是[]byte数组，只不过ide显示友好化了）</p>
<p><img src="/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/Untitled%206.png" alt></p>
<p>经过我们反序列化后，就可以将这些值放到结构体中，就相当于确定化了</p>
<p><img src="/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/Untitled%207.png" alt></p>
<p>我们查看下这部分源码</p>
<p><img src="/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/Untitled%208.png" alt></p>
<p>这里可以明显看出代码346行是将查询的数据<code>all</code>反序列化到<code>entities</code> ，那么问题就应该出现在红框那一块，点进去查看源码的话</p>
<p><img src="/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/Untitled%209.png" alt></p>
<p>我们可以看到很多关于<code>reflect</code>包的函数，可以很明显看出这里使用了反射的方式反序列化</p>
<h3 id="3-1-2-反序列化处理过程"><a href="#3-1-2-反序列化处理过程" class="headerlink" title="3.1.2 反序列化处理过程"></a>3.1.2 反序列化处理过程</h3><p>假设我们有如下JSON：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Age&quot;</span><span class="punctuation">:</span> <span class="number">21</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李四&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Age&quot;</span><span class="punctuation">:</span> <span class="number">31</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p>和如下结构体：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="type">string</span></span><br><span class="line">	Age <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么使用该方法反序列化一般的过程是怎么样的呢，怎么能够把JSON里面的数据映射到结构体里面呢？</p>
<p><img src="/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/unmarshal.png" alt></p>
<ul>
<li>首先会利用JSON扫描状态机对输入的JSON byte数组进行合法性检查，以保证后面操作JSON的正确性</li>
<li>接着会利用状态机对JSON进行解析，提取出key，value等信息</li>
<li>最后利用反射，将这些信息映射到结构体中</li>
</ul>
<p>利用反射我们可以在运行时对结构体动态赋值，对于一般结构体赋值我们可以这样显式赋值：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User&#123;<span class="string">&quot;张三&quot;</span>, <span class="number">21</span>&#125;</span><br></pre></td></tr></table></figure>
<p>但是这样就太限制了。因为对于一般的情况，我们是不知道传入的结构体和JSON的结构是怎么样的，所以我们就需要一种技术能够让我们在运行时动态获取到结构体相关的信息（比如类型和值），并且有一些方法能够操纵这些数据，比如赋值，这样的话我们就能够动态去处理这些数据了，反射能够提供方法支持，所以就是我们要用反射的原因。</p>
<h3 id="3-1-3-反射"><a href="#3-1-3-反射" class="headerlink" title="3.1.3 反射"></a>3.1.3 反射</h3><ul>
<li>通过<code>reflect.TypeOf(i interface&#123;&#125;)</code> 我们能拿到变量的类型</li>
<li>通过<code>reflect.ValueOf(i interface&#123;&#125;)</code> 我们能拿到变量的值</li>
</ul>
<p>如果我们知道了一个变量的类型和值，那么就意味着知道了这个变量的全部信息。</p>
<p>有了变量的类型之后，我们可以通过 <code>Method</code> 方法获得类型实现的方法，通过 <code>Field</code> 获取类型包含的全部字段。对于不同的类型，我们也可以调用不同的方法获取相关信息：</p>
<ul>
<li>结构体：获取字段的数量并通过下标和字段名获取字段 <code>StructField</code>；</li>
<li>哈希表：获取哈希表的 <code>Key</code> 类型；</li>
<li>函数或方法：获取入参和返回值的类型；</li>
<li>…</li>
</ul>
<p>接着我们可以利用<code>reflect.Value.Set</code> 方法更新反射对象，所以我们可以看到下面的这个代码，传入一个空的<code>entities数组</code>，然后就可以得到有具体值的<code>entities数组</code></p>
<p><img src="/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/Untitled%208.png" alt></p>
<p>反射的原理可以大概理解为：</p>
<p>因为传入的数据都是<code>interface&#123;&#125;</code>类型，其在内部存储了<code>分配给该变量的具体值（the concrete value assigned to the variable）</code>以及<code>该值的类型描述符（value&#39;s type descriptor）</code></p>
<p>在<code>build</code>时，<code>Go linker</code>会将有关应用程序使用的所有类型的信息嵌入到可执行文件中</p>
<p>转换【编译时已知的类型】到【<code>interface&#123;&#125;</code>】的过程中，GO编译器会将类型描述符指向具体的类型描述符，这是编译时已知的，所以通过这两个就能拿到相关的信息。</p>
<h3 id="3-1-4-反射缺点"><a href="#3-1-4-反射缺点" class="headerlink" title="3.1.4 反射缺点"></a>3.1.4 反射缺点</h3><p>对于本项目来讲，缺点就是慢，特别是数据量多需要循环调用反射的时候，主要的原因在于：</p>
<ol>
<li>涉及到内存分配以及后续的GC</li>
<li>每次执行时都需要验证执行的每个步骤</li>
<li>查找类型信息时<code>I/O</code>速度慢</li>
<li>等等</li>
</ol>
<h3 id="3-1-5-解决方法"><a href="#3-1-5-解决方法" class="headerlink" title="3.1.5 解决方法"></a>3.1.5 解决方法</h3><p>既然反序列化过程比较慢，那么我们可以使用第三方JSON库去提高效率。仅需要修改下源码，将<code>structs</code>部分去掉，改为调用第三方JSON库的解析方式。</p>
<p>对于序列化库的实现来讲，如果在运行时通过反射的方式进行序列化和反序列化，性能不会太好，所以高性能的序列化库很多都是通过代码生成在编译的时候提供序列化和反序列化的方法。因为在编译的时候已经知道每个字段的类型，所以无需元数据，可以聪明的对字节按照流的方式顺序处理以及作更多的优化。</p>
<p><img src="/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/Untitled%2010.png" alt></p>
<p>效率对比</p>
<p><img src="/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/Untitled%204.png" alt></p>
<p><img src="/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/Untitled%2011.png" alt></p>
<h3 id="3-1-6-方案缺点"><a href="#3-1-6-方案缺点" class="headerlink" title="3.1.6 方案缺点"></a>3.1.6 方案缺点</h3><ul>
<li>因为代码是提前生成的，所以灵活性不强</li>
<li>适用于大量数据序列化场景，如果数据量不强，效果不明显，反而增加成本</li>
<li>需要明确反序列化后的结构</li>
</ul>
<h2 id="3-2-Redis-mset-key"><a href="#3-2-Redis-mset-key" class="headerlink" title="3.2 Redis mset key"></a>3.2 Redis mset key</h2><h3 id="3-2-1-找出关键点"><a href="#3-2-1-找出关键点" class="headerlink" title="3.2.1 找出关键点"></a>3.2.1 找出关键点</h3><p>项目需要一下设置很多缓存，这个也是个优化点，因为pprof不能捕获到for循环中Redis set key的所花费的时间，所以我们只能手动打点</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">start := time.Now()</span><br><span class="line"><span class="keyword">for</span> key, value := <span class="keyword">range</span> data&#123;</span><br><span class="line">	g.Redis().Do(<span class="string">&quot;SETEX&quot;</span>, key, expiredTime, value)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(time.Now().Sub(start))</span><br></pre></td></tr></table></figure>
<p>这里数据大概有1k条，每条数据序列后长度不到20000</p>
<p>跑了一下上面的打点，需要花费<code>8.8595475s</code></p>
<p>这里瓶颈主要在于循环调用，多次调用会增加开销：</p>
<p>因为Redis本身是基于<code>request/response</code>模式，每一个命令都需要等待上一个命令响应后进行处理，中间需要经过RTT（Round Time Trip，往返延时，表示发送端从发送数据开始，到发送端收到来自接收端的确认，所需要的时间。），并且需要频繁调用系统I/O</p>
<hr>
<p>单次setx的操作所花费的时间为<code>22.9419ms</code> 压缩字符串后能减少到<code>17.9522ms</code> 但是整体调用起来差别不大</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">g.Redis().Do(<span class="string">&quot;SETEX&quot;</span>, key, expiredTime, </span><br><span class="line">			snappy.Encode(<span class="literal">nil</span>, gconv.Bytes(testPlanProcessData)))</span><br></pre></td></tr></table></figure>
<h3 id="3-2-2-mset"><a href="#3-2-2-mset" class="headerlink" title="3.2.2 mset"></a>3.2.2 mset</h3><p>对于这种需求，一个更好的方法使用<code>MSET</code>命令，可以一次性设置多个key value</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MSET k1 <span class="string">&quot;good&quot;</span> k2 <span class="string">&quot;bye&quot;</span></span><br></pre></td></tr></table></figure>
<p>这个命令是原子的，要不全部完成要么完全不完成，不会看到一部分值被更新，而其他值未更新这种情况。该命令执行后会返回”ok”字符串。</p>
<p>从Redis官方文档来看，该命令每次都是会返回成功，不会失败</p>
<blockquote>
<p>Return value<br>Simple string reply: always OK since MSET can’t fail.</p>
</blockquote>
<p>这里的意思是不会在<code>MSET</code> 阶段返回错误，有错误的话Redis会提前返回：</p>
<p>在处理命令之前会检查内存容量，如果内存容量不够，无论命令的实际响应如何，都会返回错误响应</p>
<p>效率对比：</p>
<p><code>8.8595475s</code> → <code>1.3812954s</code></p>
<h3 id="3-2-3-方案缺点"><a href="#3-2-3-方案缺点" class="headerlink" title="3.2.3 方案缺点"></a>3.2.3 方案缺点</h3><p>使用 <code>MSET</code> 不能设置过期时间，我们可以使用<code>Lua</code>脚本处理，这里是一个批量设置<code>xx:xx:</code>前缀的key过期时间脚本的示例。可直接在<code>Redis-cli</code>中执行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span> </span><br><span class="line">	<span class="string">&#x27;for i, name in ipairs(redis.call(&quot;KEYS&quot;, &quot;xx:xx:*&quot;)) </span></span><br><span class="line"><span class="string">					do redis.call(&quot;EXPIRE&quot;, name, 10); end&#x27;</span> </span><br><span class="line">0</span><br></pre></td></tr></table></figure>
<p>可以使用 <code>eval</code>命令执行<code>Lua</code>脚本</p>
<p><code>EVAL script numkeys key [key ...] arg [arg ...]</code></p>
<ul>
<li>上面最后0代表0个key</li>
<li><code>redis.call</code> 执行Redis 命令</li>
<li><code>ipairs</code>遍历集合</li>
</ul>
<h2 id="3-3-其他优化"><a href="#3-3-其他优化" class="headerlink" title="3.3 其他优化"></a>3.3 其他优化</h2><p>其他优化点都是很常见的，比如：</p>
<ul>
<li>加索引</li>
<li>多线程优化</li>
<li>避免多次调SQL，一次性查出来映射到map</li>
<li>等等</li>
</ul>
<p>这里就不赘述。</p>
<hr>
<ul>
<li><p>参考：</p>
<p>  <a target="_blank" rel="noopener external nofollow noreferrer" href="https://stackoverflow.com/questions/34605415/how-does-golang-implement-reflection">How does golang implement reflection?</a></p>
<p>  <a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.golang.org/laws-of-reflection">The Go Blog</a></p>
<p>  <a target="_blank" rel="noopener external nofollow noreferrer" href="http://cnblogs.com/clannadxr/p/11314874.html">从unmarshal带json字符串字段的json说起</a></p>
<p>  <a target="_blank" rel="noopener external nofollow noreferrer" href="https://draveness.me/golang/docs/part2-foundation/ch04-basic/golang-reflect/#43-%E5%8F%8D%E5%B0%84">Go 语言反射的实现原理</a></p>
<p>  <a target="_blank" rel="noopener external nofollow noreferrer" href="http://miloyip.github.io/rapidjson/md_doc_internals.html#IterativeParser">RapidJSON: Internals</a></p>
<p>  <a target="_blank" rel="noopener external nofollow noreferrer" href="https://zhuanlan.zhihu.com/p/37165706">Go语言encoding/json库源码分析</a></p>
<p>  <a target="_blank" rel="noopener external nofollow noreferrer" href="https://stackoverflow.com/questions/12911248/redis-set-command-cant-fail-but-can">https://stackoverflow.com/questions/12911248/redis-set-command-cant-fail-but-can</a></p>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://greenhathg.github.io">GreenHatHg</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://greenhathg.github.io/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/">https://greenhathg.github.io/2020/10/26/%E9%A1%B9%E7%9B%AEGolang%E4%BC%98%E5%8C%96%E7%82%B9/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://greenhathg.github.io" target="_blank">GreenHatHGのBlog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Golang/">Golang</a><a class="post-meta__tags" href="/tags/pprof/">pprof</a><a class="post-meta__tags" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a><a class="post-meta__tags" href="/tags/mset/">mset</a><a class="post-meta__tags" href="/tags/Redis/">Redis</a></div><div class="post-share"><div class="social-share" data-image="https://images.unsplash.com/photo-1620880762258-273a49958090?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2020/11/06/MIT6.824-MapReduce/" title="MIT6.824-MapReduce"><img class="cover" src="https://images.unsplash.com/photo-1620880762296-f9787c134352?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;ixlib=rb-1.2.1&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">MIT6.824-MapReduce</div></div><div class="info-2"><div class="info-item-1">背景有时候我们需要从一批数据中得到一些结果，比如从最频繁查询的结果集，每个单词出现的次数。随着输入的数据越来越多，为了在合理的时间内完成，单台机器可能会完成不了这个任务，所以我们必须将这个计算压力分担到多个机器上面，并行计算。 但是解决计算的标准化，数据的分配，故障处理，负载均衡等问题是个大工程，让原本简单的代码变得复杂起来。 为此，Google发明了MapReduce系统，隔离了复杂的底层，让程序员能够容易使用这个系统进行大数据量的分布式计算。 编程模型将用户的计算分为两个函数处理：Map和Reduce 函数  Map函数：输入数据，处理后生成一组键值对（中间值） Reduce函数：处理前面得到的中间值，然后将这些值合并在一起，形成更小的值集。通常，每次 Reduce调用只生成零个或一个输出值。  简约模型： 123map (k1,v1) → list(k2,v2)//这里是指对应k2的结果有多个reduce (k2,list(v2)) → list(v2)   举个例子： 现有大量的文本数据，想统计每个单词出现的次数 123456789map(string...</div></div></div></a><a class="pagination-related" href="/2020/10/19/Golang%E5%8F%8D%E5%B0%84%E5%BA%94%E7%94%A8-%E6%8E%92%E5%BA%8F/" title="Golang反射应用-排序"><img class="cover" src="https://images.unsplash.com/photo-1620880762272-c2bf6b4f1ce2?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Golang反射应用-排序</div></div><div class="info-2"><div class="info-item-1">一、反射Go基础教程可看 Go 系列教程 — 34. 反射 反射 Go 语言反射的实现原理 这里记下用的部分 1.1 reflect.Valuereflect.Value 可以表示一个任意类型的值 1234567891011121314151617181920package mainimport (	&quot;fmt&quot;	&quot;reflect&quot;)type User struct &#123;	Name string	Age int&#125;func main() &#123;	u := User&#123;&quot;张三&quot;, 56&#125;	v := reflect.ValueOf(u)	fmt.Println(v)&#125;/*output:&#123;张三 56&#125;*/ 1.2 reflect.Kind12345678910111213141516171819202122package mainimport (	&quot;fmt&quot;	&quot;reflect&quot;)type User struct...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2022/04/23/Golang-GC%E7%AC%94%E8%AE%B0-GC-Traces/" title="Golang-GC笔记-GC-Traces"><img class="cover" src="https://images.unsplash.com/photo-1621761836815-6e43911fbcfc?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1171&q=80" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2025-06-14</div><div class="info-item-2">Golang-GC笔记-GC-Traces</div></div><div class="info-2"><div class="info-item-1">来源：https://www.ardanlabs.com/blog/2019/05/garbage-collection-in-go-part2-gctraces.html 开关GC的对比有一个从不同的新闻提供商下载RSS并搜索的应用程序 在关闭GC的情况下测试并发请求应用程序耗时情况 12345$ go build$ GOGC=off ./project &gt; /dev/null# 10k requests using 100 connectionshey -m POST -c 100 -n 10000 &quot;http://localhost:5000/search?term=topic&amp;cnn=on&amp;bbc=on&amp;nyt=on&quot;  处理10k个请求需要4188ms，每秒处理约2387个请求 在开启GC的情况下呢， 123456$ GODEBUG=gctrace=1 ./project &gt; /dev/nullgc 3 @3.182s 0%: 0.015+0.59+0.096 ms clock,...</div></div></div></a><a class="pagination-related" href="/2022/04/07/Golang-GC%E7%AC%94%E8%AE%B0-Semantics/" title="Golang-GC笔记-Semantics"><img class="cover" src="https://images.unsplash.com/photo-1620880762272-c2bf6b4f1ce2?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1171&q=80" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2025-06-14</div><div class="info-item-2">Golang-GC笔记-Semantics</div></div><div class="info-2"><div class="info-item-1">来源：https://www.ardanlabs.com/blog/2018/12/garbage-collection-in-go-part1-semantics.html Garbage collectors responsibility tracking heap memory allocations freeing up allocations that are no longer needed keeping allocations that are still in-use  As of version 1.12, the Go programming language uses a non-generational concurrent tri-color mark and sweep collector. 非分代并发三色标记和扫描收集器 Collector Behaviorcollection工作会经历三个阶段  Mark Setup - STW(Stop The World) Marking - Concurrent Mark Termination -...</div></div></div></a><a class="pagination-related" href="/2020/10/19/Golang%E5%8F%8D%E5%B0%84%E5%BA%94%E7%94%A8-%E6%8E%92%E5%BA%8F/" title="Golang反射应用-排序"><img class="cover" src="https://images.unsplash.com/photo-1620880762272-c2bf6b4f1ce2?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1171&q=80" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2025-06-14</div><div class="info-item-2">Golang反射应用-排序</div></div><div class="info-2"><div class="info-item-1">一、反射Go基础教程可看 Go 系列教程 — 34. 反射 反射 Go 语言反射的实现原理 这里记下用的部分 1.1 reflect.Valuereflect.Value 可以表示一个任意类型的值 1234567891011121314151617181920package mainimport (	&quot;fmt&quot;	&quot;reflect&quot;)type User struct &#123;	Name string	Age int&#125;func main() &#123;	u := User&#123;&quot;张三&quot;, 56&#125;	v := reflect.ValueOf(u)	fmt.Println(v)&#125;/*output:&#123;张三 56&#125;*/ 1.2 reflect.Kind12345678910111213141516171819202122package mainimport (	&quot;fmt&quot;	&quot;reflect&quot;)type User struct...</div></div></div></a><a class="pagination-related" href="/2022/04/23/Golang%E7%AC%94%E8%AE%B0-Fan-in/" title="Golang笔记-Fan-in"><img class="cover" src="https://images.unsplash.com/photo-1619342802099-027bc73e30eb?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1171&q=80" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2025-06-14</div><div class="info-item-2">Golang笔记-Fan-in</div></div><div class="info-2"><div class="info-item-1">来源：https://go.dev/talks/2012/concurrency.slide  The boring function runs, like a boring party guest. 12345678910111213func boring(msg string) &#123;	for i := 0; ; i++ &#123;		fmt.Println(msg, i)		time.Sleep(time.Duration(rand.Intn(1e3)) * time.Millisecond)	&#125;&#125;func main() &#123;	go boring(&quot;boring!&quot;)	fmt.Println(&quot;I&#x27;m listening.&quot;)	time.Sleep(2 * time.Second)	fmt.Println(&quot;You&#x27;re boring; I&#x27;m leaving.&quot;)&#125;  A channel connects the main and...</div></div></div></a><a class="pagination-related" href="/2022/04/19/Golang%E7%AC%94%E8%AE%B0-Pipelines-and-cancellation/" title="Golang笔记-Pipelines-and-cancellation"><img class="cover" src="https://images.unsplash.com/photo-1619075120066-02024cb853bd?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1171&q=80" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2025-06-14</div><div class="info-item-2">Golang笔记-Pipelines-and-cancellation</div></div><div class="info-2"><div class="info-item-1">来源：Go Concurrency Patterns: Pipelines and cancellation - The Go Programming Language What is pipeline receive values from upstream via inbound channels perform some function on that data, usually producing new values send values downstream via outbound channels  Squaring numbers Generator Pattern converts a list of integers to a channel that emits the integers in the list  12345678910func gen(nums ...int) &lt;-chan int&#123;	out := make(chan int)	go func() &#123;		for _, n := range...</div></div></div></a><a class="pagination-related" href="/2021/10/08/%E7%81%AB%E8%BD%A6%E5%A4%B4%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/" title="火车头使用教程"><img class="cover" src="https://images.unsplash.com/photo-1618170673668-0eea9c66d40c?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1171&q=80" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2025-06-14</div><div class="info-item-2">火车头使用教程</div></div><div class="info-2"><div class="info-item-1">声明：本教程无任何盈利目的，仅供学习使用，也不会对网站运行造成负担，请勿用于任何商业用途。 火车头简介火车采集器官网-网页抓取工具火车头采集器免费网站采集软件  火车采集器，一款专业的互联网数据抓取、处理、分析，挖掘软件，可以灵活迅速地抓取网页上散乱分布的数据信息，并通过一系列的分析处理，准确挖掘出所需数据。火车采集器历经十二年的升级更新，积累了大量用户和良好口碑，是目前最受欢迎的网页数据采集软件。  简单来讲，就是使用软件来简化我们的爬虫过程，在整一个过程中，不需要编写代码就能够实现爬虫逻辑。 举例爬取任务需要分页爬取所有页面，并对页面上所有感兴趣的条目进一步爬取二级URL 新建任务添加一个任务 网址采集规则-网址获取  起始网址填上【第一页的URL】 网址获取选项的意思：提取当前页面上想要爬取的条目的URL，比如xx网第一页上的符合条件的所有商品链接。   12345678910111213141516171819202122&lt;div class=&quot;Z_list-box&quot;&gt;...&lt;div...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://avatars0.githubusercontent.com/u/34258355?s=460&amp;u=eb0a1ce09dd045532464cb42f020e8ba1d025b6c&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">GreenHatHg</div><div class="author-info-description">巴拉巴拉能量! rm -rf / --no-preserve-root</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">197</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">237</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/GreenHatHG"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/GreenHatHG" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:greenhat2333@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">一、前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81pprof"><span class="toc-number">2.</span> <span class="toc-text">二、pprof</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 结果分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E6%89%BE%E5%88%B0%E5%85%B3%E9%94%AE%E9%83%A8%E5%88%86"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 找到关键部分</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%BC%98%E5%8C%96%E7%82%B9"><span class="toc-number">3.</span> <span class="toc-text">三、优化点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-%E6%89%BE%E5%87%BA%E5%85%B3%E9%94%AE%E7%82%B9"><span class="toc-number">3.1.1.</span> <span class="toc-text">3.1.1 找出关键点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B"><span class="toc-number">3.1.2.</span> <span class="toc-text">3.1.2 反序列化处理过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-3-%E5%8F%8D%E5%B0%84"><span class="toc-number">3.1.3.</span> <span class="toc-text">3.1.3 反射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-4-%E5%8F%8D%E5%B0%84%E7%BC%BA%E7%82%B9"><span class="toc-number">3.1.4.</span> <span class="toc-text">3.1.4 反射缺点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-5-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="toc-number">3.1.5.</span> <span class="toc-text">3.1.5 解决方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-6-%E6%96%B9%E6%A1%88%E7%BC%BA%E7%82%B9"><span class="toc-number">3.1.6.</span> <span class="toc-text">3.1.6 方案缺点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Redis-mset-key"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 Redis mset key</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-%E6%89%BE%E5%87%BA%E5%85%B3%E9%94%AE%E7%82%B9"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.2.1 找出关键点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-mset"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2.2 mset</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-%E6%96%B9%E6%A1%88%E7%BC%BA%E7%82%B9"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.2.3 方案缺点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E5%85%B6%E4%BB%96%E4%BC%98%E5%8C%96"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 其他优化</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/06/14/Xueqiu_Forever-summary-2025-06-14/" title="[Xueqiu_Forever] 发言时段总结 - 2025-06-14"><img src="https://images.unsplash.com/photo-1618170673668-0eea9c66d40c?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="[Xueqiu_Forever] 发言时段总结 - 2025-06-14"/></a><div class="content"><a class="title" href="/2025/06/14/Xueqiu_Forever-summary-2025-06-14/" title="[Xueqiu_Forever] 发言时段总结 - 2025-06-14">[Xueqiu_Forever] 发言时段总结 - 2025-06-14</a><time datetime="2025-06-14T09:16:50.000Z" title="发表于 2025-06-14 09:16:50">2025-06-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/14/Xueqiu_ShanXing-summary-2025-06-14/" title="[Xueqiu_ShanXing] 发言时段总结 - 2025-06-14"><img src="https://images.unsplash.com/photo-1621761836815-6e43911fbcfc?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="[Xueqiu_ShanXing] 发言时段总结 - 2025-06-14"/></a><div class="content"><a class="title" href="/2025/06/14/Xueqiu_ShanXing-summary-2025-06-14/" title="[Xueqiu_ShanXing] 发言时段总结 - 2025-06-14">[Xueqiu_ShanXing] 发言时段总结 - 2025-06-14</a><time datetime="2025-06-14T08:15:28.000Z" title="发表于 2025-06-14 08:15:28">2025-06-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/01/05/CMU445-Project2-BPlusTree-Delete-Single-Threaded/" title="CMU445-Project2-BPlusTree-Delete-Single-threaded"><img src="https://images.unsplash.com/photo-1620880762258-273a49958090?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CMU445-Project2-BPlusTree-Delete-Single-threaded"/></a><div class="content"><a class="title" href="/2024/01/05/CMU445-Project2-BPlusTree-Delete-Single-Threaded/" title="CMU445-Project2-BPlusTree-Delete-Single-threaded">CMU445-Project2-BPlusTree-Delete-Single-threaded</a><time datetime="2024-01-05T12:39:43.000Z" title="发表于 2024-01-05 12:39:43">2024-01-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/31/%E7%8E%A9%E5%AE%A2%E4%BA%91%E6%8D%A2%E9%AD%94%E7%99%BE%E7%9B%92/" title="玩客云换魔百盒"><img src="https://images.unsplash.com/photo-1620880762272-c2bf6b4f1ce2?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="玩客云换魔百盒"/></a><div class="content"><a class="title" href="/2023/12/31/%E7%8E%A9%E5%AE%A2%E4%BA%91%E6%8D%A2%E9%AD%94%E7%99%BE%E7%9B%92/" title="玩客云换魔百盒">玩客云换魔百盒</a><time datetime="2023-12-31T12:44:43.000Z" title="发表于 2023-12-31 12:44:43">2023-12-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/12/CMU445-Project2-BPlusTree-Insert/" title="CMU445-Project1-BPlusTree-Insert-Single-threaded"><img src="https://images.unsplash.com/photo-1620880762296-f9787c134352?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;ixlib=rb-1.2.1&amp;auto=format&amp;fit=crop&amp;w=1171&amp;q=80" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CMU445-Project1-BPlusTree-Insert-Single-threaded"/></a><div class="content"><a class="title" href="/2023/12/12/CMU445-Project2-BPlusTree-Insert/" title="CMU445-Project1-BPlusTree-Insert-Single-threaded">CMU445-Project1-BPlusTree-Insert-Single-threaded</a><time datetime="2023-12-12T22:59:43.000Z" title="发表于 2023-12-12 22:59:43">2023-12-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2025 By GreenHatHg</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://blog-twikoo-khaki.vercel.app',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://blog-twikoo-khaki.vercel.app',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    GLOBAL_CONFIG_SITE.pageType === 'post' && getCount()

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>